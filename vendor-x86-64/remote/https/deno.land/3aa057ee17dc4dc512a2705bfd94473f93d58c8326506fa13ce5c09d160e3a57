import { ServerContext } from "./context.ts";
export type { FromManifestConfig, FromManifestOptions } from "./context.ts";
export { STATUS_CODE } from "./deps.ts";
import {
  ErrorHandler,
  FreshConfig,
  Handler,
  Handlers,
  IslandModule,
  LayoutConfig,
  MiddlewareModule,
  RouteConfig,
  ServeHandlerInfo,
  UnknownHandler,
} from "./types.ts";
import { startServer } from "./boot.ts";
export {
  defineApp,
  defineConfig,
  defineLayout,
  defineRoute,
} from "./defines.ts";
export type {
  AppContext,
  AppProps,
  DenoConfig,
  ErrorHandler,
  ErrorHandlerContext,
  ErrorPageProps,
  FreshConfig,
  FreshContext,
  FreshOptions,
  Handler,
  HandlerContext,
  Handlers,
  LayoutConfig,
  LayoutContext,
  LayoutProps,
  MiddlewareHandler,
  MiddlewareHandlerContext,
  MultiHandler,
  PageProps,
  Plugin,
  PluginAsyncRenderContext,
  PluginAsyncRenderFunction,
  PluginIslands,
  PluginMiddleware,
  PluginRenderContext,
  PluginRenderFunction,
  PluginRenderFunctionResult,
  PluginRenderResult,
  PluginRenderScripts,
  PluginRenderStyleTag,
  PluginRoute,
  RenderFunction,
  ResolvedFreshConfig,
  RouteConfig,
  RouteContext,
  RouterOptions,
  ServeHandlerInfo,
  StartOptions,
  UnknownHandler,
  UnknownHandlerContext,
  UnknownPageProps,
} from "./types.ts";
export { RenderContext } from "./render.ts";
export type { InnerRenderFunction } from "./render.ts";
export type { DestinationKind } from "./router.ts";

export interface Manifest {
  routes: Record<
    string,
    {
      // Use a more loose route definition type because
      // TS has trouble inferring normal vs aync functions. It cannot infer based on function arity
      default?: (
        // deno-lint-ignore no-explicit-any
        propsOrRequest: any,
        // deno-lint-ignore no-explicit-any
        ctx: any,
        // deno-lint-ignore no-explicit-any
      ) => Promise<any | Response> | any;
      handler?:
        // deno-lint-ignore no-explicit-any
        | Handler<any, any>
        // deno-lint-ignore no-explicit-any
        | Handlers<any, any>
        | UnknownHandler
        | ErrorHandler;
      config?: RouteConfig | LayoutConfig;
    } | MiddlewareModule
  >;
  islands: Record<string, IslandModule>;
  baseUrl: string;
}

export { ServerContext };

export async function createHandler(
  manifest: Manifest,
  config: FreshConfig = {},
): Promise<
  (req: Request, connInfo?: ServeHandlerInfo) => Promise<Response>
> {
  const ctx = await ServerContext.fromManifest(manifest, config);
  return ctx.handler();
}

export async function start(manifest: Manifest, config: FreshConfig = {}) {
  const ctx = await ServerContext.fromManifest(manifest, {
    ...config,
    dev: false,
  });
  const realConfig = config.server ?? config;
  await startServer(ctx.handler(), {
    ...realConfig,
    basePath: config?.router?.basePath ?? "",
  });
}

// denoCacheMetadata={"headers":{"last-modified":"Fri, 22 Mar 2024 21:26:14 GMT","server-timing":"fetchSource;dur=9","x-frame-options":"DENY","cross-origin-resource-policy":"same-origin","alt-svc":"h3=\":443\"; ma=86400","x-content-type-options":"nosniff","cache-status":"deno; hit","x-cache":"Hit from cloudfront","content-security-policy":"default-src 'none'; style-src 'unsafe-inline'; sandbox","via":"1.1 0d3372129d548b57c62777e24b79e514.cloudfront.net (CloudFront),HTTP/2 ams.vultr.prod.deno-cluster.net","x-amz-version-id":"VGWLedvQkmVNa2367NvJYMJXF3wuYBHF","access-control-allow-origin":"*","cache-control":"public, max-age=31536000, immutable","etag":"\"19825647daef5eaa2239ddfb10d5a68f\"","accept-ranges":"bytes","referrer-policy":"strict-origin-when-cross-origin","vary":"Accept-Encoding, Origin","content-length":"2862","content-type":"application/typescript; charset=utf-8","x-amz-cf-id":"ZEh5J1jxyBSdJU4zsrs1IApZuFsJdjoCNnoVt6R7DWPkkkKNQmxgvg==","cross-origin-embedder-policy":"same-origin","server":"AmazonS3,deployd","strict-transport-security":"max-age=63072000; includeSubDomains; preload","date":"Wed, 12 Nov 2025 19:29:49 GMT","x-deno-trace-id":"7d128d4899facf1253f6d5c4f128c6af","x-amz-replication-status":"COMPLETED","age":"1214675","x-amz-cf-pop":"AMS58-P5","cross-origin-opener-policy":"same-origin","x-amz-server-side-encryption":"AES256"},"url":"https://deno.land/x/fresh@1.6.8/src/server/mod.ts","time":1764190463}