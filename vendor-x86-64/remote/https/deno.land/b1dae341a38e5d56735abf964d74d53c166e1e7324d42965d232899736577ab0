import { VNode } from "preact";
import { DATA_ANCESTOR, DATA_CURRENT } from "../constants.ts";

export const enum UrlMatchKind {
  None,
  Ancestor,
  Current,
}

export function matchesUrl(current: string, needle: string): UrlMatchKind {
  let href = new URL(needle, "http://localhost").pathname;
  if (href !== "/" && href.endsWith("/")) {
    href = href.slice(0, -1);
  }

  if (current !== "/" && current.endsWith("/")) {
    current = current.slice(0, -1);
  }

  if (current === href) {
    return UrlMatchKind.Current;
  } else if (current.startsWith(href + "/") || href === "/") {
    return UrlMatchKind.Ancestor;
  }

  return UrlMatchKind.None;
}

/**
 * Mark active or ancestor link
 * Note: This function is used both on the server and the client
 */
export function setActiveUrl(vnode: VNode, pathname: string): void {
  const props = vnode.props as Record<string, unknown>;
  const hrefProp = props.href;
  if (typeof hrefProp === "string" && hrefProp.startsWith("/")) {
    const match = matchesUrl(pathname, hrefProp);
    if (match === UrlMatchKind.Current) {
      props[DATA_CURRENT] = "true";
      props["aria-current"] = "page";
    } else if (match === UrlMatchKind.Ancestor) {
      props[DATA_ANCESTOR] = "true";
      props["aria-current"] = "true";
    }
  }
}

// denoCacheMetadata={"headers":{"x-cache":"Hit from cloudfront","age":"167766","cache-control":"public, max-age=31536000, immutable","x-amz-server-side-encryption":"AES256","server-timing":"fetchSource;dur=341","alt-svc":"h3=\":443\"; ma=86400","via":"1.1 a44309111e5e1050ff485adaa4681ad0.cloudfront.net (CloudFront),HTTP/2 ams.vultr.prod.deno-cluster.net","cross-origin-opener-policy":"same-origin","x-amz-cf-pop":"AMS58-P5","content-length":"1290","etag":"\"8c5875609ecffdbf761741a83dc583e1\"","server":"AmazonS3,deployd","access-control-allow-origin":"*","vary":"Accept-Encoding, Origin","x-amz-version-id":"bG05Wb7RQ0MPFEXPWn3wzaO0UexUwZci","cross-origin-resource-policy":"same-origin","x-frame-options":"DENY","x-content-type-options":"nosniff","referrer-policy":"strict-origin-when-cross-origin","cache-status":"deno; hit","x-deno-trace-id":"de1d06b676692404ba9af4400bd1f0de","accept-ranges":"bytes","content-security-policy":"default-src 'none'; style-src 'unsafe-inline'; sandbox","cross-origin-embedder-policy":"same-origin","content-type":"application/typescript; charset=utf-8","last-modified":"Fri, 22 Mar 2024 21:26:14 GMT","x-amz-replication-status":"COMPLETED","strict-transport-security":"max-age=63072000; includeSubDomains; preload","date":"Mon, 24 Nov 2025 22:18:18 GMT","x-amz-cf-id":"YkBkzJumtigFlWzclyGlRbupoPAxlWuiCvRz_LMUNMfj5MzlN5TtcQ=="},"url":"https://deno.land/x/fresh@1.6.8/src/runtime/active_url.ts","time":1764190464}